<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SCP Foundation ‚Äî Amnestic Inventory System</title>
<style>
  :root {
    --bg:#000; --panel:#0a0a0a; --border:#1a1a1a; --border-bright:#333;
    --text:#ccc; --text-dim:#666; --text-bright:#eee;
    --accent:#b30000; --accent2:#ff4444;
    --green:#00cc44; --yellow:#ccaa00; --blue:#5599ff;
    --font-mono:'Courier New',Courier,monospace;
  }
  *{box-sizing:border-box;margin:0;padding:0;}
  body{background:var(--bg);color:var(--text);font-family:var(--font-mono);min-height:100vh;}

  /* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
  #login-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:20px;}
  .login-box{width:100%;max-width:440px;border:1px solid var(--border-bright);background:var(--panel);padding:32px 28px;}
  .login-logo{display:flex;flex-direction:column;align-items:center;margin-bottom:28px;gap:8px;}
  .scp-seal{width:80px;height:80px;border:3px solid var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:900;color:var(--accent);position:relative;}
  .scp-seal::after{content:'';position:absolute;inset:4px;border-radius:50%;border:1px solid #400;}
  .login-title{font-size:12px;text-align:center;color:var(--text-dim);text-transform:uppercase;letter-spacing:2px;}
  .login-subtitle{font-size:16px;color:var(--text-bright);text-transform:uppercase;letter-spacing:4px;text-align:center;}
  .form-group{margin-bottom:14px;}
  .form-group label{display:block;font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:2px;margin-bottom:5px;}
  .form-group input{width:100%;background:#050505;border:1px solid var(--border-bright);color:var(--text-bright);font-family:var(--font-mono);font-size:14px;padding:10px 12px;outline:none;transition:border-color .15s;}
  .form-group input:focus{border-color:var(--accent);}
  .btn{display:block;width:100%;padding:12px;background:var(--accent);color:#fff;border:none;font-family:var(--font-mono);font-size:13px;text-transform:uppercase;letter-spacing:3px;cursor:pointer;margin-top:8px;}
  .btn:hover{background:#900;}
  .error-msg{color:var(--accent2);font-size:11px;margin-top:10px;text-align:center;min-height:16px;text-transform:uppercase;letter-spacing:1px;}
  .login-footer{text-align:center;font-size:10px;color:#333;margin-top:12px;text-transform:uppercase;letter-spacing:1px;}
  .login-divider{border:none;border-top:1px solid #1a1a1a;margin:14px 0;}

  /* ‚îÄ‚îÄ APP ‚îÄ‚îÄ */
  #app{display:none;flex-direction:column;min-height:100vh;}
  .header{height:56px;border-bottom:1px solid var(--border-bright);display:flex;align-items:center;justify-content:space-between;padding:0 16px;background:var(--panel);position:sticky;top:0;z-index:100;gap:12px;}
  .header-left{display:flex;align-items:center;gap:10px;flex:1;min-width:0;}
  .header-scp{font-size:18px;font-weight:900;color:var(--accent);white-space:nowrap;}
  .header-title{font-size:11px;color:var(--text-dim);text-transform:uppercase;letter-spacing:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
  .header-right{display:flex;align-items:center;gap:10px;flex-shrink:0;}
  .user-badge{font-size:11px;color:var(--text-dim);border:1px solid var(--border-bright);padding:4px 8px;white-space:nowrap;max-width:140px;overflow:hidden;text-overflow:ellipsis;}
  .badge-amnestic{border-color:#555;color:#aaa;}
  .badge-mnestic{border-color:#4488ff;color:#88bbff;}
  .badge-o5{border-color:#ff4400;color:#ff8866;}
  .badge-admin{border-color:var(--yellow);color:var(--yellow);}
  .logout-btn{background:none;border:1px solid var(--border-bright);color:var(--text-dim);font-family:var(--font-mono);font-size:11px;padding:4px 8px;cursor:pointer;text-transform:uppercase;letter-spacing:1px;}
  .logout-btn:hover{border-color:var(--accent);color:var(--accent);}

  /* sync */
  #sync-status{font-size:10px;color:#333;text-align:right;padding:3px 16px;text-transform:uppercase;letter-spacing:1px;min-height:16px;}
  #sync-status.synced{color:var(--green);}
  #sync-status.syncing{color:var(--yellow);}
  #sync-status.error{color:var(--accent2);}

  /* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
  .nav-tabs{display:flex;border-bottom:1px solid var(--border-bright);background:var(--panel);overflow-x:auto;scrollbar-width:none;}
  .nav-tabs::-webkit-scrollbar{display:none;}
  .nav-tab{padding:10px 14px;font-size:11px;color:var(--text-dim);cursor:pointer;text-transform:uppercase;letter-spacing:2px;white-space:nowrap;border-bottom:2px solid transparent;transition:all .15s;background:none;border-top:none;border-left:none;border-right:none;font-family:var(--font-mono);}
  .nav-tab:hover{color:var(--text-bright);}
  .nav-tab.active{color:var(--accent2);border-bottom-color:var(--accent);}
  .nav-tab.tab-mnestic{color:#4488ff;border-bottom:2px solid #224488;animation:mnesticPulse 2.5s ease-in-out infinite;}
  .nav-tab.tab-mnestic.active{color:#88bbff;border-bottom-color:#4488ff;}
  .nav-tab.tab-ennui{color:#ff2200;border-bottom:2px solid #ff2200;animation:ennuiTabPulse 1.8s ease-in-out infinite;}
  .nav-tab.tab-ennui.active{color:#ff5533;border-bottom-color:#ff3300;}
  @keyframes mnesticPulse{0%,100%{text-shadow:0 0 4px #4488ff55}50%{text-shadow:0 0 10px #4488ffaa}}
  @keyframes ennuiTabPulse{0%,100%{color:#ff2200;text-shadow:0 0 6px #ff2200aa}50%{color:#ff5533;text-shadow:0 0 14px #ff4400cc}}

  /* ‚îÄ‚îÄ CONTENT ‚îÄ‚îÄ */
  .content{flex:1;padding:16px;}
  .section-header{font-size:11px;text-transform:uppercase;letter-spacing:3px;color:var(--text-dim);border-bottom:1px solid var(--border-bright);padding-bottom:8px;margin-bottom:14px;display:flex;align-items:center;gap:8px;}
  .section-header .dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
  .shelf-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;margin-bottom:24px;}

  /* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
  .amnestic-card{border:1px solid var(--border-bright);background:var(--panel);display:flex;flex-direction:column;}
  .amnestic-card.ennui-card{border-color:#ff330055;box-shadow:0 0 12px #ff110022;}
  .amnestic-card.mnestic-card{border-color:#224488;box-shadow:0 0 10px #002244;}
  .amnestic-card.fatal-card{border-color:#660000;box-shadow:0 0 16px #33000033;}
  .card-header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border);background:#0d0d0d;}
  .card-class{font-size:18px;font-weight:900;letter-spacing:2px;}
  .card-name{font-size:10px;color:var(--text-dim);text-align:right;text-transform:uppercase;letter-spacing:1px;}
  .card-desc{padding:8px 12px;font-size:11px;color:var(--text-dim);border-bottom:1px solid var(--border);line-height:1.6;}
  .shelf-display{padding:12px;min-height:96px;display:flex;flex-wrap:wrap;align-content:flex-start;gap:4px;border-bottom:1px solid var(--border);position:relative;}
  .shelf-dividers{position:absolute;bottom:0;left:8px;right:8px;height:3px;background:#222;}
  .vial{width:18px;height:32px;border-radius:2px 2px 4px 4px;border:1px solid rgba(255,255,255,.15);position:relative;cursor:default;transition:transform .1s;flex-shrink:0;}
  .vial:hover{transform:translateY(-2px);}
  .vial::before{content:'';position:absolute;top:-4px;left:50%;transform:translateX(-50%);width:8px;height:5px;background:inherit;border-radius:1px;border:1px solid rgba(255,255,255,.15);border-bottom:none;}
  .empty-shelf{color:#333;font-size:11px;text-align:center;width:100%;padding:16px 0;text-transform:uppercase;letter-spacing:2px;}
  .card-footer{padding:8px 12px;display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;}
  .stock-info{font-size:12px;}
  .stock-count{font-weight:700;}
  .stock-ok{color:var(--green);} .stock-warn{color:var(--yellow);} .stock-empty{color:var(--accent2);}
  .take-controls{display:flex;gap:4px;align-items:center;}
  .take-input{width:48px;background:#050505;border:1px solid var(--border-bright);color:var(--text-bright);font-family:var(--font-mono);font-size:12px;padding:4px 6px;text-align:center;outline:none;}
  .take-btn{background:var(--accent);color:#fff;border:none;font-family:var(--font-mono);font-size:11px;padding:5px 8px;cursor:pointer;text-transform:uppercase;letter-spacing:1px;position:relative;overflow:hidden;min-width:82px;text-align:center;line-height:1.4;}
  .take-btn:hover:not(:disabled){background:#900;}
  .take-btn:disabled{background:#1a1a1a;color:#555;cursor:not-allowed;}
  .take-btn.on-cooldown{background:#1a0000!important;color:var(--accent2)!important;cursor:not-allowed;}
  .cooldown-bar{position:absolute;bottom:0;left:0;height:3px;background:var(--accent2);pointer-events:none;}

  /* ‚îÄ‚îÄ ENNUI ‚îÄ‚îÄ */
  .ennui-wrapper{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:calc(100vh - 140px);padding:24px 16px;}
  .ennui-no-access{text-align:center;border:1px solid #330000;background:#060000;padding:40px 32px;max-width:420px;}
  .ennui-no-access .icon{font-size:36px;margin-bottom:12px;}
  .ennui-no-access h2{color:#661100;font-size:13px;text-transform:uppercase;letter-spacing:4px;margin-bottom:8px;}
  .ennui-no-access p{color:#441100;font-size:11px;letter-spacing:1px;line-height:1.8;}

  .ennui-protocol-box{width:100%;max-width:540px;border:2px solid #ff2200;background:#060000;padding:40px 32px;display:flex;flex-direction:column;align-items:center;gap:24px;animation:ennuiBorderPulse 1.6s ease-in-out infinite;position:relative;text-align:center;}
  @keyframes ennuiBorderPulse{0%,100%{box-shadow:0 0 20px #ff220055,0 0 60px #ff110022;border-color:#ff2200}50%{box-shadow:0 0 50px #ff3300aa,0 0 100px #ff220044;border-color:#ff5533}}
  .e-corner{position:absolute;width:16px;height:16px;border-color:#ff4400;border-style:solid;}
  .e-corner.tl{top:-2px;left:-2px;border-width:3px 0 0 3px;} .e-corner.tr{top:-2px;right:-2px;border-width:3px 3px 0 0;}
  .e-corner.bl{bottom:-2px;left:-2px;border-width:0 0 3px 3px;} .e-corner.br{bottom:-2px;right:-2px;border-width:0 3px 3px 0;}
  .ennui-protocol-box h2{color:#ff3300;font-size:14px;text-transform:uppercase;letter-spacing:6px;text-shadow:0 0 20px #ff330066;}
  .ennui-protocol-box .sub{color:#661100;font-size:10px;letter-spacing:3px;text-transform:uppercase;}
  .ennui-warning-txt{color:#883322;font-size:11px;line-height:1.8;border:1px solid #330000;background:#0a0000;padding:12px 16px;width:100%;text-align:left;}
  .ennui-warning-txt span{color:#ff4400;}

  .ennui-activate-btn{width:180px;height:180px;border-radius:50%;background:radial-gradient(circle at 35% 35%,#330000,#0d0000);border:4px solid #ff2200;color:#ff3300;font-family:var(--font-mono);font-size:15px;font-weight:900;text-transform:uppercase;letter-spacing:4px;cursor:pointer;transition:all .2s;animation:bigBtnPulse 2s ease-in-out infinite;line-height:1.4;}
  @keyframes bigBtnPulse{0%,100%{box-shadow:0 0 30px #ff220055,inset 0 0 20px #1a000044}50%{box-shadow:0 0 60px #ff3300aa,inset 0 0 40px #2a000066}}
  .ennui-activate-btn:hover:not(:disabled){background:radial-gradient(circle at 35% 35%,#550000,#1a0000);color:#ff6644;box-shadow:0 0 80px #ff440099;transform:scale(1.04);}
  .ennui-activate-btn:disabled{cursor:not-allowed;opacity:.35;animation:none;}

  /* ‚îÄ‚îÄ BLACKOUT ‚îÄ‚îÄ */
  #blackout{position:fixed;inset:0;background:#000;z-index:9999;display:none;}
  #blackout.active{display:block;}

  /* ‚îÄ‚îÄ ADMIN ‚îÄ‚îÄ */
  .admin-section{margin-bottom:28px;}
  .section-title{font-size:12px;text-transform:uppercase;letter-spacing:3px;color:var(--yellow);border-bottom:1px solid #333;padding-bottom:8px;margin-bottom:12px;}
  .firebase-setup{border:1px solid #333;background:#0d0d0d;padding:16px;margin-bottom:20px;}
  .firebase-setup.connected{border-color:#224400;}
  .setup-fields{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;}
  @media(max-width:560px){.setup-fields{grid-template-columns:1fr;}}
  .setup-label{display:block;font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:2px;margin-bottom:5px;}
  .setup-input{width:100%;background:#050505;border:1px solid var(--border-bright);color:var(--text-bright);font-family:var(--font-mono);font-size:12px;padding:8px 10px;outline:none;}
  .setup-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
  .setup-btn{background:#004400;border:1px solid var(--green);color:var(--green);font-family:var(--font-mono);font-size:11px;padding:6px 12px;cursor:pointer;text-transform:uppercase;letter-spacing:2px;}
  .setup-btn:hover{background:#006600;}
  .setup-btn.red{background:#1a0000;border-color:#660000;color:#aa3333;}
  .setup-btn.red:hover{background:#330000;}
  .setup-btn.grey{background:#111;border-color:#444;color:#888;}
  .setup-btn.grey:hover{background:#1a1a1a;}
  .setup-status{font-size:11px;color:#555;letter-spacing:1px;}
  .setup-info{font-size:11px;color:var(--text-dim);line-height:1.9;margin-bottom:14px;}
  .setup-info a{color:#88aaff;}
  .restock-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px;}
  .restock-row{display:flex;align-items:center;gap:8px;border:1px solid var(--border-bright);padding:8px 10px;background:var(--panel);}
  .restock-label{flex:1;font-size:12px;}
  .restock-label span{display:block;font-size:10px;color:var(--text-dim);margin-top:2px;}
  .restock-input{width:56px;background:#050505;border:1px solid var(--border-bright);color:var(--text-bright);font-family:var(--font-mono);font-size:12px;padding:4px 6px;text-align:center;outline:none;}
  .restock-btn{background:#004400;border:1px solid var(--green);color:var(--green);font-family:var(--font-mono);font-size:11px;padding:4px 8px;cursor:pointer;text-transform:uppercase;}
  .restock-btn:hover{background:#006600;}

  /* ‚îÄ‚îÄ LOG ‚îÄ‚îÄ */
  .log-wrapper{overflow-x:auto;}
  .log-table{width:100%;border-collapse:collapse;font-size:12px;min-width:480px;}
  .log-table th{text-align:left;padding:6px 10px;border-bottom:1px solid var(--border-bright);color:var(--text-dim);font-size:10px;text-transform:uppercase;letter-spacing:2px;background:#0d0d0d;}
  .log-table td{padding:6px 10px;border-bottom:1px solid var(--border);vertical-align:top;}
  .log-table tr:hover td{background:#0a0a0a;}
  .log-enter{color:var(--green);} .log-take{color:var(--blue);} .log-fail{color:var(--accent2);} .log-admin{color:var(--yellow);} .log-ennui{color:#ff6600;}
  .log-time{color:var(--text-dim);white-space:nowrap;font-size:10px;}
  .clear-btn{background:none;border:1px solid #444;color:#666;font-family:var(--font-mono);font-size:10px;padding:3px 8px;cursor:pointer;text-transform:uppercase;letter-spacing:1px;float:right;margin-top:-28px;}
  .clear-btn:hover{border-color:var(--accent2);color:var(--accent2);}

  /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
  #toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(20px);background:#111;border:1px solid var(--border-bright);color:var(--text-bright);font-family:var(--font-mono);font-size:12px;padding:10px 16px;text-align:center;opacity:0;transition:all .25s;pointer-events:none;z-index:9998;max-width:320px;white-space:pre-wrap;}
  #toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
  #toast.toast-ok{border-color:var(--green);} #toast.toast-err{border-color:var(--accent2);} #toast.toast-warn{border-color:var(--yellow);}

  @keyframes iconFlicker{0%,92%,100%{opacity:1}93%{opacity:.2}94%{opacity:1}96%{opacity:.1}97%{opacity:1}}
  @media(max-width:480px){.header-title{display:none;}.shelf-grid{grid-template-columns:1fr;}.content{padding:10px;}}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen">
  <div class="login-box">
    <div class="login-logo">
      <div class="scp-seal">SCP</div>
      <div class="login-subtitle">Foundation</div>
      <div class="login-title">Amnestic Inventory System</div>
    </div>
    <div class="form-group">
      <label>Nome de Usu√°rio (Roblox)</label>
      <input type="text" id="login-user" placeholder="SeuNomeRoblox" autocomplete="off">
    </div>
    <div class="form-group">
      <label>Senha de Acesso</label>
      <input type="password" id="login-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    </div>
    <button class="btn" onclick="doLogin()">AUTENTICAR</button>
    <div class="error-msg" id="login-error"></div>
    <div class="login-footer">SCP Foundation ¬∑ Confidencial ¬∑ Uso Interno</div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <div class="header">
    <div class="header-left">
      <div class="header-scp">SCP</div>
      <div class="header-title">Amnestic Inventory System</div>
    </div>
    <div class="header-right">
      <div class="user-badge" id="header-user-badge"></div>
      <button class="logout-btn" onclick="doLogout()">Sair</button>
    </div>
  </div>

  <div class="nav-tabs" id="nav-tabs">
    <!-- tabs injected dynamically based on access level -->
  </div>
  <div id="sync-status"></div>

  <!-- INVENTORY -->
  <div class="content" id="content-inventory" style="display:none">
    <div class="section-header"><div class="dot" style="background:#b30000"></div>Amn√©sticos ‚Äî Estoque Geral</div>
    <div class="shelf-grid" id="shelf-grid-amnestic"></div>
  </div>

  <!-- MNESTICS -->
  <div class="content" id="content-mnestic" style="display:none">
    <div class="section-header"><div class="dot" style="background:#4488ff"></div>Agentes Mn√©sticos ‚Äî Divis√£o Antimem√©tica</div>
    <div class="shelf-grid" id="shelf-grid-mnestic"></div>
  </div>

  <!-- ENNUI -->
  <div class="content" id="content-ennui" style="display:none">
    <div class="ennui-wrapper">
      <div class="ennui-protocol-box" id="ennui-protocol-box">
        <div class="e-corner tl"></div><div class="e-corner tr"></div>
        <div class="e-corner bl"></div><div class="e-corner br"></div>
        <div>
          <div style="font-size:40px;animation:iconFlicker 3s step-end infinite">‚ö†</div>
          <h2>Protocolo Ennui</h2>
          <div class="sub" style="margin-top:6px">Classe-E ¬∑ Autoriza√ß√£o O5 ¬∑ N√≠vel 5</div>
        </div>
        <div class="ennui-warning-txt">
          <span>‚ö† AVISO CR√çTICO:</span> A ativa√ß√£o do Protocolo Ennui disparar√° transmiss√£o de
          alerta a todos os agentes durante <span>10 minutos</span> (20 mensagens a cada 30s).
          O evento √© <span>irrevers√≠vel e auditado</span> pelo Conselho O5.
        </div>
        <button class="ennui-activate-btn" id="ennui-activate-btn" onclick="activateEnnui()">ATIVAR</button>
        <div style="font-size:10px;color:#441100;letter-spacing:2px;text-transform:uppercase">
          Operador: <span id="ennui-operator" style="color:#883322"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- ADMIN -->
  <div class="content" id="content-admin" style="display:none">
    <div class="admin-section">
      <div class="section-title">üåê Banco de Dados Global ‚Äî Firebase</div>
      <div class="firebase-setup" id="firebase-setup-box">
        <div class="setup-info">
          O Firebase permite que o estoque seja <strong style="color:var(--text-bright)">global e em tempo real</strong> ‚Äî qualquer retirada feita por qualquer usu√°rio aparece instantaneamente para todos.<br><br>
          <strong style="color:var(--yellow)">Como configurar (5 min, gratuito):</strong><br>
          1. Acesse <a href="https://console.firebase.google.com" target="_blank">console.firebase.google.com</a> ‚Üí crie um projeto<br>
          2. No menu lateral: <strong>Build ‚Üí Realtime Database ‚Üí Create Database</strong><br>
          3. Escolha "Start in <strong>test mode</strong>" ‚Üí Create<br>
          4. Copie a URL do banco (ex: <span style="color:#888">https://meu-projeto-default-rtdb.firebaseio.com</span>)<br>
          5. Cole abaixo e clique em Salvar:
        </div>
        <div id="firebase-connected-banner" style="display:none;background:#001a00;border:1px solid var(--green);padding:8px 12px;font-size:11px;color:var(--green);letter-spacing:1px;margin-bottom:12px;">
          ‚úì Firebase conectado ‚Äî estoque global ativo em tempo real.
        </div>
        <div class="setup-fields">
          <div>
            <label class="setup-label">URL do Realtime Database</label>
            <input class="setup-input" type="text" id="setup-fb-url" placeholder="https://meu-projeto-rtdb.firebaseio.com">
          </div>
          <div>
            <label class="setup-label">Secret / Token de acesso</label>
            <input class="setup-input" type="password" id="setup-fb-secret" placeholder="(deixe em branco se Test Mode)">
          </div>
        </div>
        <div class="setup-actions">
          <button class="setup-btn" onclick="saveFirebaseConfig()">‚úì Salvar e Conectar</button>
          <button class="setup-btn grey" onclick="testFirebaseConfig()">‚ü≥ Testar</button>
          <button class="setup-btn red" onclick="clearFirebaseConfig()">‚úï Remover</button>
          <span class="setup-status" id="firebase-setup-status"></span>
        </div>
      </div>
    </div>

    <div class="admin-section">
      <div class="section-title">Re-estoque</div>
      <div class="restock-grid" id="restock-grid"></div>
    </div>

    <div class="admin-section">
      <div class="section-title">Hist√≥rico<button class="clear-btn" onclick="clearLog()">Limpar</button></div>
      <div class="log-wrapper">
        <table class="log-table">
          <thead><tr><th>Hora</th><th>Usu√°rio</th><th>Evento</th></tr></thead>
          <tbody id="log-body"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div id="blackout"></div>
<div id="toast"></div>

<script>
// ============================================================
// Cole a URL do seu Webhook do Discord aqui:
const DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/1475898574079529213/OSYboaFzEL-mkq9X8u1Ho7P7nh0vXRq66-YlQbQirOzs0JCdo3CVvdBwQn2qqUVl9xGC";
// ============================================================

const PASS_AMNESTIC = "4mn32t1c033#SCP";
const PASS_MNESTIC  = "mn3St1C055%SCP";
const PASS_O5       = "REVVUyBOT1MgRVNRVUVDRVUgQVNTSU0gQ09NTyBOw5NTIE8gRVNRVUVDRU1PUw";  // Protocolo Ennui + acesso total
const PASS_ADMIN    = "We Must Remember#!";   // mesmo que O5, mas mostra painel admin

// N√≠veis de acesso: "amnestic" | "mnestic" | "o5" | "admin"
// admin = mesma senha do O5, mas revela painel de re-estoque

const AMNESTICS = [
  {id:"A",name:"Classe-A",codename:"General Retrograde",    color:"#2a2a2a",stripe:"#888",  unit:"frascos",def:50, cl:"N√≠vel 1",
   desc:"Remove mem√≥rias recentes das √∫ltimas 5-6 horas. Uso de campo geral. Administrado via spray nasal ou comprimido. Mais eficaz quando o sujeito relembra as mem√≥rias alvo."},
  {id:"B",name:"Classe-B",codename:"Regressive Retrograde", color:"#1a2a1a",stripe:"#4a4",  unit:"frascos",def:30, cl:"N√≠vel 1",
   desc:"Apagamento lento e incremental de mem√≥rias recentes, avan√ßando retroativamente. Dose de 75mg apaga ~24 horas. Via comprimido ou inje√ß√£o."},
  {id:"C",name:"Classe-C",codename:"Targeted Retrograde",   color:"#1a1a2a",stripe:"#44c",  unit:"frascos",def:20, cl:"N√≠vel 2",
   desc:"Remo√ß√£o cirurgicamente precisa de mem√≥rias espec√≠ficas. Requer neuroimagem e estimula√ß√£o transcraniana. Uso principalmente em instala√ß√µes."},
  {id:"D",name:"Classe-D",codename:"Progressive Retrograde",color:"#2a2a00",stripe:"#ca0",  unit:"frascos",def:10, cl:"N√≠vel 2",
   desc:"Apaga mem√≥rias mais antigas primeiro, avan√ßando progressivamente. Oposto da Classe-B. Raramente utilizado. N√£o afeta mem√≥rias impl√≠citas."},
  {id:"E",name:"Classe-E",codename:"Ennui Protocol",        color:"#1a0800",stripe:"#f60",  unit:"frascos",def:8,  cl:"O5 / N√≠vel 5", ennui:true,
   desc:"‚ö† PROTOCOLO ENNUI. Induz complac√™ncia psicol√≥gica com o an√¥malo. O sujeito interpreta o sobrenatural como absolutamente normal. Administrado via IV. Acesso estritamente restrito."},
  {id:"F",name:"Classe-F",codename:"Fugue",                 color:"#2a001a",stripe:"#c06",  unit:"frascos",def:5,  cl:"N√≠vel 4",
   desc:"Induz amn√©sia dissociativa profunda. O sujeito esquece sua identidade e pode receber uma nova. Uso em desligamento de pessoal. Aprova√ß√£o O5 necess√°ria."},
  {id:"G",name:"Classe-G",codename:"Gaslighting",           color:"#001a2a",stripe:"#08c",  unit:"frascos",def:15, cl:"N√≠vel 3",
   desc:"Causa d√∫vida sobre a autenticidade de mem√≥rias. Derrealiza eventos an√¥malos, fazendo-os parecer sonhos ou alucina√ß√µes."},
  {id:"H",name:"Classe-H",codename:"Anterograde",           color:"#1a1a00",stripe:"#aa0",  unit:"frascos",def:12, cl:"N√≠vel 2",
   desc:"Bloqueia a forma√ß√£o de novas mem√≥rias enquanto ativo. Dose de 75mg dura ~24h. N√£o apaga mem√≥rias existentes."},
  {id:"I",name:"Classe-I",codename:"Transient Retrograde",  color:"#0a1a1a",stripe:"#0aa",  unit:"frascos",def:8,  cl:"N√≠vel 1",
   desc:"Induz amn√©sia transit√≥ria bloqueando vias neurais de longo prazo. O sujeito fica temporariamente incapaz de recordar o passado. ~24h de dura√ß√£o."},
];

const MNESTICS = [
  {id:"W",name:"Classe-W",codename:"Antimemetic Perception",color:"#001a2a",stripe:"#08f",unit:"ampolas",def:20,cl:"Div. Antimem√©tica",
   desc:"Permite perceber e reter conhecimento de antimemes. Principal droga de campo da Divis√£o Antimem√©tica. Efeitos: n√°usea, risco de c√¢ncer pancre√°tico, pesadelos."},
  {id:"X",name:"Classe-X",codename:"Memory Restoration",    color:"#001a1a",stripe:"#0ba",unit:"ampolas",def:10,cl:"Div. Antimem√©tica",
   desc:"Restaura consci√™ncia de antimemes ou mem√≥rias suprimidas. Efeito 'whiplash': supress√£o temporal √© revertida abruptamente, podendo causar danos f√≠sicos em doses altas."},
  {id:"Y",name:"Classe-Y",codename:"Perfect Recall",        color:"#1a001a",stripe:"#93c",unit:"ampolas",def:8, cl:"Div. Antimem√©tica",
   desc:"Concede recall perfeito de todas as mem√≥rias adquiridas durante o efeito. Efeitos: n√°usea intensa, risco de c√¢ncer pancre√°tico, pesadelos graves."},
  {id:"Z",name:"Classe-Z",codename:"Total Recall ‚Äî FATAL",  color:"#220000",stripe:"#f22",unit:"ampolas",def:2, cl:"O5 APENAS",fatal:true,
   desc:"‚õî LETAL. Uma dose torna o sujeito incapaz de esquecer qualquer coisa pelo resto da vida. Morte por convuls√£o em horas. Uso em campo PROIBIDO."},
];

const ALL = [...AMNESTICS, ...MNESTICS];

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let currentUser = null, accessLevel = null;
let stock = {}, accessLog = [], cooldowns = {};
let globalCooldownUntil = 0; // timestamp ‚Äî cooldown compartilhado entre TODOS os frascos
let ennuiInterval = null, ennuiCount = 0;
let fbUrl = "", fbSecret = "";

// ‚îÄ‚îÄ FIREBASE CONFIG (stored in localStorage) ‚îÄ‚îÄ
function loadFirebaseConfig() {
  try {
    const c = JSON.parse(localStorage.getItem("scp_fb_cfg")||"{}");
    fbUrl    = c.url    || "";
    fbSecret = c.secret || "";
  } catch(e){ fbUrl=""; fbSecret=""; }
}

function saveFirebaseConfig() {
  const url    = (document.getElementById("setup-fb-url")||{}).value||"";
  const secret = (document.getElementById("setup-fb-secret")||{}).value||"";
  const st     = document.getElementById("firebase-setup-status");
  if (!url.trim()) { if(st){st.style.color="#ff4444";st.textContent="Informe a URL do banco.";} return; }
  fbUrl = url.trim().replace(/\/$/,"");
  fbSecret = secret.trim();
  localStorage.setItem("scp_fb_cfg", JSON.stringify({url:fbUrl, secret:fbSecret}));
  if(st){st.style.color="var(--yellow)";st.textContent="Testando...";}
  testFirebaseConfig();
}

async function testFirebaseConfig() {
  const st = document.getElementById("firebase-setup-status");
  const u  = ((document.getElementById("setup-fb-url")||{}).value||"").trim().replace(/\/$/,"") || fbUrl;
  if (!u) { if(st){st.style.color="#ff4444";st.textContent="Configure a URL primeiro.";} return; }
  if(st){st.style.color="var(--yellow)";st.textContent="‚ü≥ Testando...";}
  try {
    const auth = fbSecret ? `?auth=${fbSecret}` : "";
    const r = await fetch(`${u}/ping.json${auth}`, {method:"PUT", headers:{"Content-Type":"application/json"}, body:'"ok"'});
    if (!r.ok) throw new Error("HTTP "+r.status);
    fbUrl = u;
    localStorage.setItem("scp_fb_cfg", JSON.stringify({url:fbUrl, secret:fbSecret}));
    if(st){st.style.color="var(--green)";st.textContent="‚úì Conectado! Estoque global ativo.";}
    updateFbBanner();
    loadGlobalStock();
  } catch(e) {
    if(st){st.style.color="#ff4444";st.textContent="‚úï Falha: "+e.message+". Verifique a URL e se o banco est√° em Test Mode.";}
  }
}

function clearFirebaseConfig() {
  if(!confirm("Remover Firebase? O estoque voltar√° a ser local.")) return;
  fbUrl=""; fbSecret="";
  localStorage.removeItem("scp_fb_cfg");
  const bi=document.getElementById("setup-fb-url"); if(bi) bi.value="";
  const bs=document.getElementById("setup-fb-secret"); if(bs) bs.value="";
  const st=document.getElementById("firebase-setup-status"); if(st) st.textContent="";
  updateFbBanner();
  setSyncStatus("","‚Äî Armazenamento local");
}

function updateFbBanner() {
  const b=document.getElementById("firebase-connected-banner");
  if(b) b.style.display = fbUrl ? "block":"none";
  const box=document.getElementById("firebase-setup-box");
  if(box) box.className = fbUrl ? "firebase-setup connected":"firebase-setup";
}

function loadSetupInputs() {
  const bi=document.getElementById("setup-fb-url");    if(bi&&fbUrl)    bi.value=fbUrl;
  const bs=document.getElementById("setup-fb-secret"); if(bs&&fbSecret) bs.value=fbSecret;
  updateFbBanner();
}

// ‚îÄ‚îÄ GLOBAL STOCK via Firebase ‚îÄ‚îÄ
function setSyncStatus(cls,txt) {
  const el=document.getElementById("sync-status"); if(el){el.className=cls;el.textContent=txt;}
}

async function loadGlobalStock() {
  if (!fbUrl) return;
  setSyncStatus("syncing","‚ü≥ Sincronizando estoque...");
  try {
    const auth = fbSecret ? `?auth=${fbSecret}` : "";
    const r = await fetch(`${fbUrl}/stock.json${auth}`);
    if (!r.ok) throw new Error("HTTP "+r.status);
    const data = await r.json();
    if (data && typeof data === "object") {
      Object.assign(stock, data);
      localStorage.setItem("scp_stock_v4", JSON.stringify(stock));
      renderAll();
      renderAdminRestock();
    }
    setSyncStatus("synced","‚úì Estoque global sincronizado");
  } catch(e) {
    setSyncStatus("error","‚ö† Falha na sincroniza√ß√£o ‚Äî usando cache local");
  }
}

async function saveGlobalStock() {
  localStorage.setItem("scp_stock_v4", JSON.stringify(stock));
  if (!fbUrl) { setSyncStatus("","‚Äî Armazenamento local"); return; }
  setSyncStatus("syncing","‚ü≥ Salvando...");
  try {
    const auth = fbSecret ? `?auth=${fbSecret}` : "";
    await fetch(`${fbUrl}/stock.json${auth}`, {
      method:"PUT", headers:{"Content-Type":"application/json"}, body:JSON.stringify(stock)
    });
    setSyncStatus("synced","‚úì Salvo globalmente");
  } catch(e) { setSyncStatus("error","‚ö† Erro ao salvar globalmente"); }
}

// ‚îÄ‚îÄ DISCORD ‚îÄ‚îÄ
async function sendWebhook(msg) {
  if (!DISCORD_WEBHOOK_URL || DISCORD_WEBHOOK_URL==="SEU_WEBHOOK_AQUI") return;
  try {
    await fetch(DISCORD_WEBHOOK_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:msg})});
  } catch(e){}
}

// ‚îÄ‚îÄ LOG ‚îÄ‚îÄ
function addLog(type,user,detail) {
  const now=new Date();
  const ts=now.toLocaleDateString("pt-BR")+" "+now.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit",second:"2-digit"});
  accessLog.unshift({type,user,detail,time:ts});
  if(accessLog.length>300) accessLog.pop();
  localStorage.setItem("scp_log_v4",JSON.stringify(accessLog));
  refreshLog();
}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ
let toastT;
function showToast(msg,type="ok") {
  const t=document.getElementById("toast"); t.textContent=msg; t.className="show toast-"+type;
  clearTimeout(toastT); toastT=setTimeout(()=>{t.className="";},3500);
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
function initStock() {
  ALL.forEach(a=>{stock[a.id]=a.def;});
  try {
    const s=localStorage.getItem("scp_stock_v4"); if(s) Object.assign(stock,JSON.parse(s));
    const l=localStorage.getItem("scp_log_v4"); if(l) accessLog=JSON.parse(l);
  } catch(e){}
  loadFirebaseConfig();
}

// ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ
document.getElementById("login-pass").addEventListener("keydown",e=>{if(e.key==="Enter")doLogin();});
document.getElementById("login-user").addEventListener("keydown",e=>{if(e.key==="Enter")document.getElementById("login-pass").focus();});

function doLogin() {
  const user=document.getElementById("login-user").value.trim();
  const pass=document.getElementById("login-pass").value;
  const err=document.getElementById("login-error");
  if(!user){err.textContent="Informe seu nome de usu√°rio.";return;}

  let level=null;
  if      (pass===PASS_O5)       level="o5";       // O5 / admin ‚Äî mesma senha
  else if (pass===PASS_MNESTIC)  level="mnestic";
  else if (pass===PASS_AMNESTIC) level="amnestic";

  if(level) {
    currentUser=user; accessLevel=level; err.textContent="";
    launchApp();
    const icons={amnestic:"‚úÖ",mnestic:"‚¨°",o5:"üîë"};
    sendWebhook(`${icons[level]||"‚úÖ"} **${user}** entrou no sistema (${level.toUpperCase()}).`);
    addLog(level==="o5"?"admin":"enter", user, `Login ‚Äî n√≠vel ${level}`);
  } else {
    err.textContent="Senha inv√°lida. Acesso negado.";
    sendWebhook(`‚ùå **${user}** tentou entrar sem sucesso.`);
    addLog("fail",user||"?","Tentativa de login com senha incorreta");
    document.getElementById("login-pass").value="";
  }
}

function doLogout() {
  clearEnnuiAlert();
  currentUser=null; accessLevel=null;
  document.getElementById("app").style.display="none";
  document.getElementById("login-screen").style.display="flex";
  document.getElementById("login-user").value="";
  document.getElementById("login-pass").value="";
  document.getElementById("login-error").textContent="";
}

function launchApp() {
  document.getElementById("login-screen").style.display="none";
  document.getElementById("app").style.display="flex";

  // Badge
  const badge=document.getElementById("header-user-badge");
  const badgeLabels={amnestic:"Amn√©sticos",mnestic:"Mn√©sticos",o5:"O5 / Admin"};
  badge.textContent=`${currentUser} [${badgeLabels[accessLevel]||accessLevel}]`;
  const badgeCls={amnestic:"badge-amnestic",mnestic:"badge-mnestic",o5:"badge-o5"};
  badge.className="user-badge "+(badgeCls[accessLevel]||"");

  document.getElementById("ennui-operator").textContent=currentUser;
  buildNav();
  renderAll();
  refreshLog();

  // First tab
  const firstTab = {amnestic:"inventory",mnestic:"mnestic",o5:"inventory"}[accessLevel]||"inventory";
  switchTab(firstTab);

  if(fbUrl) loadGlobalStock();
  else setSyncStatus("","‚Äî Armazenamento local (configure Firebase no painel Admin)");
  if(accessLevel==="o5") loadSetupInputs();
}

// ‚îÄ‚îÄ NAV ‚îÄ‚îÄ
function buildNav() {
  const nav=document.getElementById("nav-tabs");
  nav.innerHTML="";
  const tabs=[];
  if(accessLevel==="amnestic"||accessLevel==="o5") tabs.push({id:"inventory",label:"Estoque",cls:""});
  if(accessLevel==="mnestic"||accessLevel==="o5")  tabs.push({id:"mnestic", label:"‚¨° Mn√©sticos",cls:"tab-mnestic"});
  if(accessLevel==="o5")                           tabs.push({id:"ennui",   label:"‚ö† PROTOCOLO ENNUI ‚ö†",cls:"tab-ennui"});
  if(accessLevel==="o5")                           tabs.push({id:"admin",   label:"‚öô Admin",cls:""});
  tabs.forEach(t=>{
    const btn=document.createElement("button");
    btn.className="nav-tab "+(t.cls||"");
    btn.id="tab-"+t.id;
    btn.textContent=t.label;
    btn.onclick=()=>switchTab(t.id);
    nav.appendChild(btn);
  });
}

function switchTab(tab) {
  ["inventory","mnestic","ennui","admin"].forEach(t=>{
    const el=document.getElementById("content-"+t); if(el) el.style.display="none";
    const btn=document.getElementById("tab-"+t); if(btn) btn.classList.remove("active");
  });
  const el=document.getElementById("content-"+tab); if(el) el.style.display="block";
  const btn=document.getElementById("tab-"+tab); if(btn) btn.classList.add("active");
  if(tab==="admin") renderAdminRestock();
}

// ‚îÄ‚îÄ ENNUI ‚îÄ‚îÄ
function activateEnnui() {
  const btn=document.getElementById("ennui-activate-btn");
  btn.disabled=true;
  addLog("ennui",currentUser,"‚ö† PROTOCOLO ENNUI ATIVADO");
  sendWebhook(`@everyone\nüü†üü†üü† **PROTOCOLO ENNUI ATIVADO** üü†üü†üü†\n‚ö† **Operador:** \`${currentUser}\`\n‚ö† **Status:** ATIVO ‚Äî 10 minutos de transmiss√£o iniciados\n‚ö† Todos os agentes: verifiquem protocolo de resposta antimem√©tica IMEDIATAMENTE.`);
  ennuiCount=1;
  ennuiInterval=setInterval(()=>{
    ennuiCount++;
    sendWebhook(`üî¥ **[ALERTA ENNUI ${ennuiCount}/20]** ‚Äî Protocolo Ennui **ATIVO**. Operador: \`${currentUser}\` | Agentes de campo: verifiquem protocolo antimem√©tico IMEDIATAMENTE.`);
    if(ennuiCount>=20) clearEnnuiAlert();
  },30000);

  // 15s blackout then restore
  const blackout=document.getElementById("blackout");
  blackout.classList.add("active");
  setTimeout(()=>{
    blackout.classList.remove("active");
    btn.disabled=false;
  },15000);
}

function clearEnnuiAlert() {
  if(ennuiInterval){clearInterval(ennuiInterval);ennuiInterval=null;}
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ
function renderAll() {
  document.getElementById("shelf-grid-amnestic").innerHTML=AMNESTICS.map(a=>cardHTML(a,false)).join("");
  document.getElementById("shelf-grid-mnestic").innerHTML=MNESTICS.map(a=>cardHTML(a,true)).join("");
}

function cardHTML(a,isMnestic) {
  const qty=stock[a.id]??0;
  const sc=qty===0?"stock-empty":qty<=5?"stock-warn":"stock-ok";
  const sl=qty===0?"SEM ESTOQUE":`${qty} ${a.unit}`;
  const MAX=30;
  let vials="";
  if(qty===0) vials=`<div class="empty-shelf">‚Äî VAZIO ‚Äî</div>`;
  else {
    const n=Math.min(qty,MAX);
    for(let i=0;i<n;i++) vials+=`<div class="vial" style="background:${a.color};border-color:${a.stripe};"></div>`;
    if(qty>MAX) vials+=`<div style="font-size:10px;color:#555;align-self:center;padding-left:4px">+${qty-MAX}</div>`;
  }
  let cls=a.ennui?" ennui-card":a.fatal?" fatal-card":isMnestic?" mnestic-card":"";
  return `<div class="amnestic-card${cls}" id="card-${a.id}">
    <div class="card-header">
      <div class="card-class" style="color:${a.stripe}">${a.name}</div>
      <div class="card-name">${a.codename}<br><small style="color:#444">${a.cl}</small></div>
    </div>
    <div class="card-desc">${a.desc}</div>
    <div class="shelf-display" id="shelf-${a.id}">${vials}<div class="shelf-dividers"></div></div>
    <div class="card-footer">
      <div class="stock-info">Dispon√≠vel: <span class="stock-count ${sc}" id="sl-${a.id}">${sl}</span></div>
      <div class="take-controls">
        <input class="take-input" type="number" min="1" max="${qty}" value="1" id="qty-${a.id}">
        <button class="take-btn" id="btn-${a.id}" ${qty===0?"disabled":""} onclick="takeItem('${a.id}')">RETIRAR<div class="cooldown-bar" id="cd-${a.id}" style="width:0"></div></button>
      </div>
    </div>
  </div>`;
}

// ‚îÄ‚îÄ COOLDOWN GLOBAL (20s entre QUALQUER retirada) ‚îÄ‚îÄ
const COOLDOWN_MS=20000;
const cdTimers={};

function takeItem(id) {
  const a=ALL.find(x=>x.id===id); if(!a) return;
  const input=document.getElementById("qty-"+id);
  const qty=parseInt(input.value)||1;
  if(qty<1){showToast("Quantidade inv√°lida.","err");return;}
  if(qty>(stock[id]??0)){showToast("Estoque insuficiente.","warn");return;}

  // Verifica cooldown global
  const now=Date.now();
  if(globalCooldownUntil>now) {
    const rem=Math.ceil((globalCooldownUntil-now)/1000);
    showToast(`Aguarde ${rem}s antes da pr√≥xima retirada.`,"warn");
    return;
  }

  stock[id]=(stock[id]??0)-qty;
  saveGlobalStock();
  refreshCard(id);
  sendWebhook(`üì¶ **${currentUser}** retirou **${qty} ${a.unit}** de **${a.name} (${a.codename})**.`);
  addLog("take",currentUser,`Retirou ${qty} ${a.unit} de ${a.name}`);
  showToast(`${qty} ${a.unit} de ${a.name} retirado(s).`,"ok");
  if(accessLevel==="o5") renderAdminRestock();

  // Inicia cooldown GLOBAL ‚Äî bloqueia TODOS os bot√µes
  globalCooldownUntil=now+COOLDOWN_MS;
  startGlobalCooldownUI();
}

function startGlobalCooldownUI() {
  // Desabilita todos os bot√µes de retirada e mostra barra de progresso
  ALL.forEach(a=>{
    const btn=document.getElementById("btn-"+a.id);
    const bar=document.getElementById("cd-"+a.id);
    if(!btn) return;
    btn.disabled=true;
    btn.classList.add("on-cooldown");
    if(bar) bar.style.width="100%";
    if(btn.childNodes[0]) btn.childNodes[0].nodeValue="20s ";
  });

  // Limpa timers anteriores
  if(cdTimers._global) clearInterval(cdTimers._global);
  let elapsed=0;
  cdTimers._global=setInterval(()=>{
    elapsed+=500;
    const pct=Math.max(0,100-(elapsed/COOLDOWN_MS)*100);
    const rem=Math.max(0,Math.ceil((COOLDOWN_MS-elapsed)/1000));
    ALL.forEach(a=>{
      const btn=document.getElementById("btn-"+a.id);
      const bar=document.getElementById("cd-"+a.id);
      if(bar) bar.style.width=pct+"%";
      if(btn&&btn.childNodes[0]) btn.childNodes[0].nodeValue=rem>0?`${rem}s `:"RETIRAR";
    });
    if(elapsed>=COOLDOWN_MS) {
      clearInterval(cdTimers._global);
      ALL.forEach(a=>{
        const btn=document.getElementById("btn-"+a.id);
        const bar=document.getElementById("cd-"+a.id);
        if(btn){btn.classList.remove("on-cooldown");btn.disabled=(stock[a.id]??0)===0;}
        if(bar) bar.style.width="0";
      });
    }
  },500);
}

function refreshCard(id) {
  const a=ALL.find(x=>x.id===id); if(!a) return;
  const qty=stock[id]??0;
  const sc=qty===0?"stock-empty":qty<=5?"stock-warn":"stock-ok";
  const sl=qty===0?"SEM ESTOQUE":`${qty} ${a.unit}`;
  const shelf=document.getElementById("shelf-"+id);
  if(shelf){
    const MAX=30; let v="";
    if(qty===0) v=`<div class="empty-shelf">‚Äî VAZIO ‚Äî</div>`;
    else{const n=Math.min(qty,MAX);for(let i=0;i<n;i++)v+=`<div class="vial" style="background:${a.color};border-color:${a.stripe};"></div>`;if(qty>MAX)v+=`<div style="font-size:10px;color:#555;align-self:center;padding-left:4px">+${qty-MAX}</div>`;}
    shelf.innerHTML=v+`<div class="shelf-dividers"></div>`;
  }
  const lbl=document.getElementById("sl-"+id); if(lbl){lbl.textContent=sl;lbl.className="stock-count "+sc;}
  const inp=document.getElementById("qty-"+id); if(inp) inp.max=qty;
  // n√£o mexe nos bot√µes aqui ‚Äî o cooldown cuida disso globalmente
}

// ‚îÄ‚îÄ ADMIN RESTOCK ‚îÄ‚îÄ
function renderAdminRestock() {
  const grid=document.getElementById("restock-grid"); if(!grid) return;
  grid.innerHTML=ALL.map(a=>{
    const qty=stock[a.id]??0;
    const tag=a.fatal?`<span style="color:#ff4444;font-size:10px">[FATAL] </span>`:"";
    return `<div class="restock-row">
      <div class="restock-label">${tag}<strong style="color:${a.stripe}">${a.name}</strong><span>${qty} ${a.unit} atual</span></div>
      <input class="restock-input" type="number" min="1" value="10" id="rq-${a.id}">
      <button class="restock-btn" onclick="doRestock('${a.id}')">+Adicionar</button>
    </div>`;
  }).join("");
}

function doRestock(id) {
  const a=ALL.find(x=>x.id===id); if(!a) return;
  const v=parseInt((document.getElementById("rq-"+id)||{}).value)||0;
  if(v<1){showToast("Quantidade inv√°lida.","err");return;}
  stock[id]=(stock[id]??0)+v;
  saveGlobalStock(); renderAdminRestock(); renderAll();
  addLog("admin",currentUser,`Re-estocou ${v} ${a.unit} de ${a.name}`);
  showToast(`+${v} ${a.unit} adicionados a ${a.name}`,"ok");
}

// ‚îÄ‚îÄ LOG ‚îÄ‚îÄ
function refreshLog() {
  const tbody=document.getElementById("log-body"); if(!tbody) return;
  if(!accessLog.length){
    tbody.innerHTML=`<tr><td colspan="3" style="color:#333;text-align:center;padding:20px;font-size:11px;text-transform:uppercase;letter-spacing:2px">Nenhum registro</td></tr>`;return;
  }
  const map={enter:["log-enter","‚úÖ"],take:["log-take","üì¶"],fail:["log-fail","‚ùå"],admin:["log-admin","‚öô"],ennui:["log-ennui","‚ö†"],amnestic:["log-enter","‚úÖ"],mnestic:["log-enter","‚¨°"],o5:["log-admin","üîë"]};
  tbody.innerHTML=accessLog.map(e=>{
    const[cls,icon]=map[e.type]||["","‚Ä¢"];
    return `<tr><td class="log-time">${e.time}</td><td style="font-weight:700">${e.user}</td><td class="${cls}">${icon} ${e.detail}</td></tr>`;
  }).join("");
}

function clearLog() {
  if(!confirm("Limpar todo o hist√≥rico?")) return;
  accessLog=[];
  localStorage.setItem("scp_log_v4","[]");
  refreshLog();
}

// ‚îÄ‚îÄ START ‚îÄ‚îÄ
initStock();
</script>
</body>
</html>